- tags: always
  include_vars: "{{ item }}"
  with_items:
    - resources.yml
    - bootstrap-vars.yml
    - access.yml
    - ssh-public-keys.yml

- name: Work directories for openshift-installer
  file:
    state: directory
    path: "{{ item }}"
  with_items:
    - "{{ bootstrap_topdir }}"
    - "{{ bootstrap_ocp_config_dir }}"

- name: "{{ bootstrap_topdir }}/install-config.yaml"
  copy:
    dest: "{{ bootstrap_topdir }}/install-config.yaml"
    content: >-
      {{ lookup("template", "ocp-install-config.yaml") }}
  vars:
    # The template explicitly relies on the following variables:
    ocp_config_pull_secret: "{{ xaasible_pull_secret }}"
    ocp_config_resources: >-
      {{ resources_openshift_clusters[inventory_hostname] }}

- name: "Create manifests under {{ bootstrap_ocp_config_dir }}/manifests"
  shell:
    creates: "{{ bootstrap_ocp_config_dir }}/manifests"
    cmd: |
      set -e -x
      cp {{ bootstrap_topdir }}/install-config.yaml {{ bootstrap_ocp_config_dir }}/
      openshift-install create manifests --dir {{ bootstrap_ocp_config_dir }}

- name: Git clone repo isovalent
  ansible.builtin.git:
    repo: {{ _cilium_config.git_repo }}
    dest: {{ _cilium_config.git_bastion_dir }}

- name: Copy cilium configuration file to manifest dir
  ansible.builtin.copy:
    src: {{ _cilium_config.git_bastion_dir }}/manifests/cilium.v{{cilium_version}}/*
    dest: {{ bootstrap_ocp_config_dir }}/manifests/

- name: Copy cluster-network-02-config to cluster-network-02-config-local.yml to disable kube-proxy
  ansible.builtin.copy:
    src: {{ bootstrap_ocp_config_dir }}/manifests/cluster-network-02-config.yml
    dest: {{ bootstrap_ocp_config_dir }}/manifests/cluster-network-02-config-local.yml

- name: Replace apiVersion in cluster-network-02-config-local.yml
  ansible.builtin.lineinfile:
    path: {{ bootstrap_ocp_config_dir }}/manifests/cluster-network-02-config-local.yml
    search_string: 'apiVersion: config.openshift.io/v1'
    line: 'apiVersion: operator.openshift.io/v1'

- name: Add deployKubeProxy at false in cluster-network-02-config-local.yml
  ansible.builtin.lineinfile:
    path: {{ bootstrap_ocp_config_dir }}/manifests/cluster-network-02-config-local.yml
    insertafter: 'spec:'
    line: '  deployKubeProxy: false'

- name: Insert/Update eth0 configuration stanza in /etc/network/interfaces
        (it might be better to copy files into /etc/network/interfaces.d/)
  ansible.builtin.blockinfile:
    path: {{ bootstrap_ocp_config_dir }}/manifests/cluster-network-06-cilium-00002-cilium-ee-olm-deployment.yaml
    insertbefore: 'image:'
    block: |
        - name: KUBERNETES_SERVICE_HOST  #override the KUBERNETES apiserver.
          value: "api.{{ inventory_hostname }}" 
        - name: KUBERNETES_SERVICE_PORT  #override the KUBERNETES port.
          value: "6443"

- name: "{{ bootstrap_topdir }}/manifest/cluster-network-07-cilium-ciliumconfig.yaml"
  copy:
    dest: "{{ bootstrap_topdir }}/manifests/"
    content: >-
      {{ lookup("template", "cluster-network-07-cilium-ciliumconfig.yaml") }}
