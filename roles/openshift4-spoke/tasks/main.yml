- tags: always
  include_vars: spoke-vars.yml

- name: "Spoke cluster: prepare"
  include_tasks:
    file: spoke-prep.yml
    apply:
      tags:
        - openshift
        - openshift.spoke
        - openshift.spoke.prep
  tags:
    - openshift
    - openshift.spoke
    - openshift.spoke.prep

- tags: always
  vars:
    _clusterdeployment_object_is_missing: >-
      {{ 0 == (query("kubernetes.core.k8s", kubeconfig=spoke_kubeconfig_of_hub,
                     kind="ClusterDeployment", namespace=spoke_namespace_in_hub)
              | length) }}
  when:
    - inventory_manually_created_cluster_name is not defined
    - _clusterdeployment_object_is_missing
  block:
    - set_fact:
        spoke_reconnect_info: >-
          {{ lookup("existing_cluster_details", cluster_name=inventory_hostname,
                    kubeconfig=xaasible_kubeconfig)
          | default(None) }}

    - when: spoke_reconnect_info != None
      name: "Reconnect to spoke cluster(s)"
      include_tasks:
        file: spoke-reconnect.yml
        apply:
          tags:
            - openshift
            - openshift.spoke
            - openshift.spoke.reconnect
      tags:
        - openshift
        - openshift.spoke
        - openshift.spoke.reconnect

    - when: spoke_reconnect_info == None
      name: "Install spoke cluster(s)"
      include_tasks:
        file: spoke-install.yml
        apply:
          tags:
            - openshift
            - openshift.spoke
            - openshift.spoke.install
      tags:
        - openshift
        - openshift.spoke
        - openshift.spoke.install

- include_tasks:
    file: spoke-xaasctl.yml
    apply:
      tags:
        - openshift
        - openshift.spoke
        - openshift.spoke.xaasctl
        - all.xaasctl
      delegate_to: localhost
      vars:
        ansible_connection: local
  tags:
    - openshift
    - openshift.spoke
    - openshift.spoke.xaasctl
    - all.xaasctl

- tags: always
  name: Log in to spoke clusters
  changed_when: false  # Eh. It only changes a cache.
  shell:
    cmd: |
      env KUBECONFIG={{ xaasible_kubeconfig }} ./xaasctl login-cluster {{ inventory_hostname }}
  vars:
    ansible_connection: local
    ansible_python_interpreter: "{{ ansible_playbook_python }}"

- include_tasks:
    file: spoke-backdoor.yml
    apply:
      tags:
        - openshift
        - openshift.spoke
        - openshift.spoke.backdoor
      environment:
        KUBECONFIG: "{{ xaasible_kubeconfig }}"  # Unless countermanded inside spoke-backdoor.yml
  tags:
    - openshift
    - openshift.spoke
    - openshift.spoke.backdoor
